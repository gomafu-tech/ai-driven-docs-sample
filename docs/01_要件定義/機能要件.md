# 機能要件定義書

## 1. 利用者管理機能

### 利用者カードルール
- 貸出時に利用者カードの提示が必須
- 利用者カードは有効期限5年間
- 利用者カードのWeb申請には必要な証明書類の提示が必要

### 利用申請フロー

```mermaid
stateDiagram-v2
    [*] --> 申請提出
    申請提出 --> 申請中
    申請中 --> 承認
    申請中 --> 否認
    承認 --> 会員カード発行
    否認 --> [*]
    会員カード発行 --> [*]
```

## 2. 貸出・返却機能

### 個人貸出ルール
- 貸出は貸出中の資料を含めて最大10冊まで
- 貸出期間は3週間
- 予約がない場合に限り、最大2回かつ2週間の延長が可能
- 返却期限を過ぎた場合に返却日から超過日数分の貸出停止処分

### 団体貸出ルール
- 団体として利用申請が必要
- 団体利用は最大100冊、貸出期間は31日とする

### 貸出状態遷移

```mermaid
stateDiagram-v2
    [*] --> 貸出可能
    貸出可能 --> 貸出中 : 貸出処理
    貸出中 --> 返却済 : 返却処理
    貸出中 --> 延長 : 延長処理(予約なし)
    延長 --> 返却済 : 返却処理
    延長 --> 再延長 : 延長処理(最大2回)
    再延長 --> 返却済 : 返却処理
    貸出中 --> 延滞 : 期限超過
    延長 --> 延滞 : 期限超過
    再延長 --> 延滞 : 期限超過
    延滞 --> 返却済 : 返却処理
    延滞 --> 強制キャンセル : 紛失・破損
    強制キャンセル --> 弁償中
    弁償中 --> 弁償完了
    返却済 --> [*]
    弁償完了 --> [*]
```

## 3. 予約機能

### 予約ルール
- 予約は貸出中の蔵書を含めて最大10冊まで
- 予約の取置きは7日間まで
- 取置き期限を過ぎた場合は予約取り消しとなる
- 同一書誌の予約は一度に1つまで

### 予約状態遷移

```mermaid
stateDiagram-v2
    [*] --> 予約申込
    予約申込 --> 予約待ち : 貸出中の場合
    予約申込 --> 取置き中 : 利用可能な場合
    予約待ち --> 取置き中 : 返却により利用可能
    取置き中 --> 貸出済 : 取置き期間内貸出
    取置き中 --> 予約取消 : 7日経過
    予約待ち --> 予約取消 : 利用者キャンセル
    貸出済 --> [*]
    予約取消 --> [*]
```

## 4. 弁償機能

### 弁償ルール
- 資料を紛失、破損した場合は弁償が済むまで新規の貸出停止
- 紛失した資料は貸出を強制キャンセル

### 弁償処理フロー

```mermaid
flowchart TD
    A[資料紛失・破損報告] --> B{紛失 or 破損?}
    B -->|紛失| C[貸出強制キャンセル]
    B -->|破損| D[損害評価]
    C --> E[弁償金額算定]
    D --> E
    E --> F[利用者通知]
    F --> G[弁償金支払い]
    G --> H[貸出制限解除]
    H --> I[処理完了]
```

## 5. 相互貸渡機能

### 相互貸渡ルール
- 別図書館からの貸出依頼を日次のファイル連携で受付可能
- 貸出期限は貸出先図書館のルールによって期限設定される
- 対象書籍が貸出中ならば予約、予約中ならば次の予約者として扱う
- 基本料金350円 + 郵送料の前納を持って郵送とする
- 連携ファイルに記載の住所（貸出先図書館または申請者の住所）に郵送する

### 相互貸渡フロー

```mermaid
flowchart TD
    A[他図書館から依頼ファイル受信] --> B{資料利用可能?}
    B -->|利用可能| C[貸出処理]
    B -->|貸出中| D[予約登録]
    B -->|予約中| E[予約待ち登録]
    C --> F[郵送準備]
    D --> G[返却待ち]
    E --> H[順番待ち]
    G --> I[利用可能通知]
    H --> I
    I --> C
    F --> J[料金請求]
    J --> K{料金確認?}
    K -->|確認済| L[郵送実行]
    K -->|未確認| M[郵送保留]
    L --> N[貸出完了]
    M --> O[再確認依頼]
    O --> K
```

