# BF006: 予約キャンセル

## 概要
利用者がオンラインで自身の予約をキャンセルする業務フロー

## アクター
- **利用者**: 図書館会員

## 前提条件
- 利用者が図書館会員として登録済み
- 利用者がオンラインシステムにログイン済み
- キャンセル対象の予約が存在する

## 業務フロー

```mermaid
flowchart TD
    subgraph "利用者"
        A[SU14: 予約一覧画面にアクセス]
        B[自分の予約一覧を確認]
        C[キャンセルしたい予約を選択]
        D[SU16: 予約キャンセル確認画面]
        E{キャンセル確認}
        F[キャンセル実行]
    end
    
    subgraph "システム"
        G[予約一覧を表示]
        H{予約ステータス確認}
        I[キャンセル処理実行]
        J[予約ステータスを更新]
        K[利用者にキャンセル完了通知]
        L[待ち順位を更新]
        M[次順位利用者に通知]
    end
    
    A --> G
    G --> B
    B --> C
    C --> H
    H -->|キャンセル可能| D
    H -->|キャンセル不可| B
    D --> E
    E -->|キャンセルする| F
    E -->|キャンセルしない| B
    F --> I
    I --> J
    J --> K
    K --> L
    L --> M
```

## キャンセル可能条件
1. **予約中**: まだ取り置きされていない状態
2. **期限内**: 予約有効期限が切れていない
3. **権限確認**: 本人の予約である

## キャンセル不可条件
1. **取り置き済み**: すでに書籍が取り置きされている
2. **期限切れ**: 予約有効期限が過ぎている
3. **処理中**: 他の処理（貸出等）が進行中

## 成果物
- 予約キャンセルレコード（予約テーブルのステータス更新）
- キャンセル通知メール
- 待ち順位更新レコード

## 後続処理
- 次順位利用者への予約可能通知
- 予約待ち順位の繰り上げ

## 例外処理
- **システムエラー**: エラーメッセージ表示、後日再試行案内
- **ログインセッション切れ**: 再ログイン案内
- **同時キャンセル**: 他のユーザーが同じ書籍をキャンセルした場合の処理

## 注意事項
- キャンセル後の再予約は通常の予約申込として扱う
- 頻繁なキャンセルは利用制限の対象となる可能性がある
- 取り置き後のキャンセルは窓口での手続きが必要