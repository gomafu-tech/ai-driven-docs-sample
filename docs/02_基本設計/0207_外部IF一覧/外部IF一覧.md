# 外部システム連携仕様

## 外部IF一覧

| 外部システム名 | ファイル名 | 方向 | 連携方式 | 連携タイミング |
|--------------|------------------|------|---------|--------------|
| 全国図書館相互貸渡システム | 相互貸渡情報.csv | 受信 | AWS S3 | 日次（深夜2時） |
| ○○決済サービス | 入金データ.csv | 受信 | AWS S3 | 日次（朝6時） |

## 外部IF詳細

### 1. 相互貸渡情報.csv

**提供元**: 全国図書館相互貸渡システム

#### 概要
- 他の図書館からの借りたい本の依頼を、相互貸渡システム経由で受信

#### ファイル仕様

**ファイル名**: `相互貸渡情報.csv`  
**文字コード**: UTF-8  
**改行コード**: LF

**ファイルレイアウト**:

| No | 項目名 | 型 | 桁数 | 必須 | 説明 |
|----|--------|----|----|------|------|
| 1 | 依頼番号 | 文字列 | 10 | ○ | 相互貸渡システムで採番される一意の番号 |
| 2 | 依頼日 | 日付 | 8 | ○ | YYYYMMDD形式 |
| 3 | 提携図書館コード | 文字列 | 10 | ○ | 提携図書館.図書館コードと紐付け |
| 4 | 書誌ID | 文字列 | 12 | ○ | 書誌.書誌IDと紐付け |
| 5 | ISBN | 文字列 | 13 | - | 参考情報として使用 |
| 6 | 書名 | 文字列 | 400 | ○ | 書誌確認用 |
| 7 | 郵送先住所 | 文字列 | 200 | ○ | 相互貸渡申込.郵送先住所へ格納 |
| 8 | 郵送先電話番号 | 文字列 | 12 | ○ | 相互貸渡申込.郵送先電話番号へ格納 |
| 9 | 郵送先氏名 | 文字列 | 50 | ○ | 相互貸渡申込.郵送先氏名へ格納 |
| 10 | 入金期限 | 日付 | 8 | ○ | YYYYMMDD形式、相互貸渡申込.入金期限へ格納 |

#### 処理概要
1. AWS S3から日次ファイルを取得
2. ファイルを解析し、妥当性チェック
3. 各レコードごとに以下を実行：
   - 相互貸渡テーブルに新規レコード作成
   - 相互貸渡イベントテーブルに「申込」イベント作成
   - 相互貸渡申込テーブルに詳細情報登録
4. 利用料（350円）を自動計算して設定
5. エラーレコードはログ出力し、処理継続

#### 処理フロー図
![相互貸渡処理フロー](相互貸渡処理.drawio.svg)

### 2. 入金データ.csv

**提供元**: ○○決済サービス

#### 概要
- 相互貸渡の利用料（350円＋郵送料）および弁償請求の入金情報を受信
- 日次で受信し、入金状況を更新
- コンビニ決済、銀行振込、クレジットカード決済に対応

#### ファイル仕様

**ファイル名**: `入金データ.csv`  
**文字コード**: UTF-8  
**改行コード**: LF

**ファイルレイアウト**:

| No | 項目名 | 型 | 桁数 | 必須 | 説明 |
|----|--------|----|----|------|------|
| 1 | 入金番号 | 文字列 | 20 | ○ | 決済代行業者の管理番号 |
| 2 | 入金日 | 日付 | 8 | ○ | YYYYMMDD形式 |
| 3 | 決済種別 | 文字列 | 2 | ○ | 01:相互貸渡、02:弁償 |
| 4 | 請求番号 | 文字列 | 10 | ○ | 相互貸渡ID or 弁償請求ID |
| 5 | 入金額 | 数値 | 10 | ○ | 税込金額 |
| 6 | 決済方法 | 文字列 | 2 | ○ | 01:コンビニ、02:銀行、03:クレジット |
| 7 | 決済手数料 | 数値 | 10 | ○ | 決済代行業者手数料 |
| 8 | 入金ステータス | 文字列 | 1 | ○ | 1:正常、2:取消、3:エラー |

#### 処理概要
1. AWS S3から日次ファイルを取得
2. ファイルを解析し、妥当性チェック
3. 決済種別に応じて処理分岐：
   - **相互貸渡（01）の場合**：
     - 相互貸渡入金テーブルに登録
     - 相互貸渡イベントテーブルに「入金」イベント作成
     - 予約テーブルに新規作成し、書籍を確保
   - **弁償（02）の場合**：
     - 弁償入金テーブルに登録
     - 貸出停止解除処理を実行
4. 入金ステータスが「2:取消」の場合は取消処理
5. エラーレコードはログ出力し、処理継続

#### 処理フロー図
![入金データ取込処理フロー](入金データ取込処理.drawio.svg)

## エラー処理

### 共通エラー処理
- ファイル取得エラー：管理者へメール通知、リトライ（3回まで）
- フォーマットエラー：該当レコードをスキップ、エラーログ記録
- 業務エラー（存在しない図書館コード等）：エラーテーブルに記録、手動確認

### リカバリ処理
- 前日分までの未処理ファイルを自動で再処理
- 手動での再取込機能を管理画面に実装

## 監視項目
- ファイル受信状況（遅延アラート）
- エラー件数（閾値超過でアラート）
- 処理時間（性能劣化監視）
