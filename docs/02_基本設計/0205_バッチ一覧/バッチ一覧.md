# バッチ処理仕様

## バッチ一覧

| バッチID | バッチ名 | 概要 | 実行タイミング |
|----------|----------|------|----------------|
| B001 | 相互貸渡情報取込バッチ | 他図書館からの貸出依頼情報を取込み、相互貸渡申込を作成 | 日次（深夜2時） |
| B002 | 入金データ取込バッチ | 決済代行業者からの入金情報を取込み、入金処理を実行 | 日次（朝6時） |
| B003 | 貸出期限超過チェックバッチ | 貸出期限を超過した貸出を検出し、会員の貸出停止処理を実行 | 日次（深夜1時） |
| B004 | 予約取置期限切れバッチ | 取置期限（7日間）を超過した予約を検出し、キャンセル処理を実行 | 日次（深夜1時） |
| B005 | 相互貸渡入金期限チェックバッチ | 相互貸渡の入金期限を超過した申込を検出し、催促通知を送信 | 日次（朝9時） |
| B006 | 返却期限事前通知バッチ | 返却期限3日前の貸出を抽出し、リマインダーメールを送信 | 日次（朝10時） |
| B007 | 予約可能通知バッチ | 返却により予約可能になった書籍を検出し、予約者へ通知 | 日次（朝10時） |
| B008 | 会員カード有効期限チェックバッチ | 有効期限切れカードのステータス更新と事前通知（30日前）を実行 | 日次（深夜3時） |
| B009 | 利用申請ステータス更新バッチ | 長期間承認待ちの申請（30日以上）を自動否認し、通知を送信 | 日次（深夜3時） |
| B012 | 相互貸渡郵送完了通知バッチ | 郵送完了した相互貸渡情報を外部システムへ送信 | 日次（夕方18時） |

## バッチ詳細仕様

### B001: 相互貸渡情報取込バッチ

**処理概要**：
1. AWS S3から「相互貸渡情報.csv」を取得
2. ファイル内容の妥当性チェック
3. レコードごとに相互貸渡申込を作成
4. 処理結果をログ出力

**関連テーブル**：
- 相互貸渡
- 相互貸渡イベント
- 相互貸渡申込

### B002: 入金データ取込バッチ

**処理概要**：
1. AWS S3から「入金データ.csv」を取得
2. 決済種別に応じて相互貸渡/弁償の入金処理
3. 相互貸渡の場合は予約作成
4. 弁償の場合は貸出停止解除

**関連テーブル**：
- 相互貸渡入金
- 弁償入金
- 予約

### B003: 貸出期限超過チェックバッチ

**処理概要**：
1. 貸出中テーブルから期限超過レコードを抽出
2. 該当会員の貸出停止フラグを更新
3. 延滞通知メール送信
4. 処理履歴を記録

**関連テーブル**：
- 貸出中
- 会員
- 通知履歴（システムテーブル）

### B004: 予約取置期限切れバッチ

**処理概要**：
1. 取置き中テーブルから期限切れレコードを抽出
2. 予約キャンセル処理を実行
3. 次の予約者がいれば通知
4. 蔵書ステータスを「貸出可能」に更新

**関連テーブル**：
- 取置き中
- 予約
- 予約イベント
- 蔵書

### B005: 相互貸渡入金期限チェックバッチ

**処理概要**：
1. 相互貸渡申込から入金期限超過を抽出
2. 初回超過：催促メール送信
3. 7日超過：キャンセル処理実行
4. 処理履歴を記録

**関連テーブル**：
- 相互貸渡申込
- 相互貸渡入金
- 通知履歴（システムテーブル）

### B006: 返却期限事前通知バッチ

**処理概要**：
1. 貸出中から3日後に期限となるレコードを抽出
2. 会員のメールアドレスを取得
3. リマインダーメール送信
4. 送信履歴を記録

**関連テーブル**：
- 貸出中
- 会員（個人会員/団体会員）
- 通知履歴（システムテーブル）

### B007: 予約可能通知バッチ

**処理概要**：
1. 返却された書籍の予約状況を確認
2. 予約中テーブルから次の予約者を特定
3. 予約取置き処理を実行
4. 取置完了メールを送信

**関連テーブル**：
- 返却
- 予約中
- 予約取置き
- 会員（個人会員/団体会員）

### B008: 会員カード有効期限チェックバッチ

**処理概要**：
1. 会員カードの有効期限を確認
2. 期限切れ：ステータスを「無効」に更新
3. 30日前：更新案内メール送信
4. 処理履歴を記録

**関連テーブル**：
- 会員カード
- 会員（個人会員/団体会員）
- 通知履歴（システムテーブル）

### B009: 利用申請ステータス更新バッチ

**処理概要**：
1. 利用申請から30日以上「申請中」を抽出
2. 自動否認処理を実行
3. 申請者へ否認通知メール送信
4. 利用申請イベントに記録

**関連テーブル**：
- 利用申請
- 利用申請イベント
- 利用申請否認
- 個人会員利用申請提出/団体会員利用申請提出

### B012: 相互貸渡郵送完了通知バッチ

**処理概要**：
1. 当日郵送完了した相互貸渡を抽出
2. 「郵送完了通知.csv」を作成
3. AWS S3へファイルをアップロード
4. 送信履歴を記録

**関連テーブル**：
- 相互貸渡郵送
- 相互貸渡
- 提携図書館

**出力ファイル仕様**：
- ファイル名：`YUSO_KANRYO_YYYYMMDD.csv`
- 内容：相互貸渡ID、郵送日、提携図書館コード